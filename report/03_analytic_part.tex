\chapter{Аналитическая часть}

%В данном разделе рассматриваются алгоритмы построения реалистичных изображений и способы представления трехмерных моделей в программе. Также обосновывается сделанный выбор.

В данном разделе проводится формализация объектов сцены, рассматриваются способы представления поверхностей трехмерных моделей и методы создания трёхмерного реалистичного изображения.

\section{Формализация задачи}

\subsection{Функциональные требования к разрабатываемому программному обеспечению}
На рисунке~\ref{img:0_idef0} представлена функциональная модель программы в нотации IDEF0, характеризующая требования к програмному обеспечению.
\FloatBarrier
\imgw{0.9\textwidth}{0_idef0}{Функциональная модель программы в нотации IDEF0}
\FloatBarrier

\subsection{Формализация объектов сцены}
Сцена состоит из следующих обьектов:
\begin{itemize}
	\item Шахматная доска 8x8 клеток. Основание шахматной доски цвета дерева, клетки -- черного и белого цвета;
	\item Набор шахмантых фигуры двух цветов: пешка, ладья, конь, слон, ферзь, король;
	\item Точечный источник света. Задается положением в пространстве и интенсивностью излучейния;
	\item Камера. Задается положением в пространстве и вектором взгляда.
\end{itemize}

Форма и размер шахматных фигур и шахматной доски соответсвует стандарту шахматного оборудования и игровых площадок, предназначенных для проведения турниров ФИДЕ~\cite{FIDE2015}.

\clearpage
\section{Анализ способов представления поверхностей трехмерных моделей}
Поверхность трехмерной модели можно задать несколькими способами~\cite{deymin}:
\begin{itemize}
	\item \textbf{Полигональная сетка.} В данном случае поверхность представляеися как совокупность связанных между собой плоских многоугольников. Большинство обьектов, не имеющих изгибов, например, таких как шахматная достка, можно точно описать полигональной сеткой. Этот способ также применяется для представления объектов, ограниченных криволинейными
	поверхностями, однако в таком случае обьект будет описан достаточно приблизительно.
	
	\item \textbf{Аналитический способ.} Поверхность заданная таким способом описывается функцией зависимости координат от некоторого параметра. Главным достоинством данного метода является высокая точность описания поверхности, которая нужна в большинстве вычислительных программ, однако из-за необходимости проведения большого количества математических вычислений при визуализации данных поверхносей, время их отрисовки будет значительно больше времени отрисовки поверхностей заданных множеством полигонов.
\end{itemize}

\subsection*{Вывод}
Для решения задачи визуализации шахматной доски и шахматных фигур нет большой необходимости в точности предсталвения поверхностей. Именно поэтому для уменьшения времени отрисовки сцены был выбран способ задания поверхностей моделей полигональной сеткой.

\clearpage
\section{Анализ алгоритмов удаления невидимых линий и поверхностей}
Для создания реалистичного изображения необходимо учитывать такие факторы как невидимые линии и поверхности, тени, освещение, свойства материалов объекта (способность отражать и преломлять свет).

\subsection{Алгоритм Робертса}

Алгоритм Робертса решает задачу удаления невидимых линий и работает в объектном пространстве исключительно с выпуклыми телами, если тело является не выпуклым, то его нужно разбить на выпуклые составляющие~\cite{rodgersCG}.

\textbf{Этапы алгоритма:}
\begin{enumerate}[label=\arabic*)]
	\item \textbf{Подготовка исходных данных.} В данном алгоритме выпуклое многогранное тело представляется набором пересекающихся плоскостей. Формируется матрица тела~$V$, где каждый столбец содержит коэффициенты уравнения плоскости грани~$ax + by + cz + d = 0$:
	\begin{equation}
		V = \begin{pmatrix}
			a_{1} & a_{2} & \ldots & a_{n}\\
			b_{1} & b_{2} & \ldots & b_{n}\\
			c_{1} & c_{2} & \ldots & c_{n}\\
			d_{1} & d_{2} & \ldots & d_{n}
		\end{pmatrix}.
	\end{equation}
	\item \textbf{Удаление ребер, экранируемых самим телом.} Используется вектор взгляда~$E = (0, 0, -1, 0)$ для определения невидимых граней. При умножении вектора $E$ на матрицу тела $V$ отрицательные компоненты полученного вектора будут соответствовать невидимым граням;
	
	\item \textbf{Удаление невидимых ребер, экранируемых другими телами.} Для определения невидимых точек ребра строится луч, соединяющий точку наблюдения с точкой на ребре. Точка невидима, если луч на своём пути встречает в качестве преграды тело, т.е. проходит через него;
\end{enumerate}

\textbf{Преимущества алгоритма Робертса:}
\begin{itemize}
	\item Высокая точность благодаря работе в объектном пространстве;
\end{itemize}

\textbf{Недостатки алгоритма Робертса:}
\begin{itemize}
	\item Не работает с невыпуклыми телами;
	\item Невозможность визуализации отражающих поверхностей;
%	\item Квадратичная сложность по числу объектов;
\end{itemize}


\subsection{Алгоритм, использующий z-буфер}
Алгоритм Z--буфера работает в пространстве изображений и использует два буфера: буфер кадра для хранения цвета каждого
пикселя и Z--буфер для хранения глубины каждого пикселя \cite{shikinStCG}.

\textbf{Этапы алгоритма:}
\begin{enumerate}[label=\arabic*)]
	\item Инициализация Z--буфера минимально возможными значениями и буфера кадра значениями пикселя, описывающими фон;
	\item Преобразование каждой проекции грани многоугольников в растровую форму;
	\item Вычисление для каждого пикселя с координатами $(x, y)$, его глубины $Z(x, y)$.
	\item Сравнение глубины $Z(x, y)$ новых пикселей с текущими в Z--буфере и обновление буфера кадра при необходимости;
\end{enumerate}

\textbf{Преимущества алгоритма Z--буфера:}
\begin{itemize}
%	\item Время работы алгоритма не зависит от разрешения обьекта сцены (числа граней поверхности многогранника)
%	\item Линейная сложность по числу точек растра и усредненного числа граней поверхности многогранника;
	\item Простота алгоритма и используемого в нем набора операций;
\end{itemize}

\textbf{Недостатки алгоритма Z--буфера:}
\begin{itemize}
	\item Большой объём требуемой памяти;
	\item Невозможность визуализации отражающих поверхностей;
\end{itemize}

\subsection{Алгоритм обратной трассировки лучей}
Алгоритм обратной трассировки лучей заключается в отслеживии траектории лучей, которые исходят из точки наблюдателя и проходят через центр пикселя растра в направлении сцены. \cite{shikinDinamica}.

\textbf{Этапы алгоритма:}
\begin{enumerate}[label=\arabic*)]
	\item Преобразование сцены в пространство изображения, т. е. область видимости наблюдателя разбивается на пиксели.
	\item Испускание лучей от наблюдателя через пиксели растра к сцене.
	\item Определение ближайшего пересечения лучей с объектами сцены.
	\item Определение находится ли точка пересечения в тени путем испускания луча из этой точки в направлении источника света. И если луч пересекает какие-либо объекты сцены, то точка находится в тени.
	\item Рекурсивное отражение и/или преломление лучей при наличии отражающих или прозрачных материалов.
	\item Учёт теней путём проверки видимости световых источников из точки пересечения.
\end{enumerate}

\textbf{Преимущества алгоритма обратной трассировки лучей:}
\begin{itemize}
	\item Высокая реалистичность синтезируемого изображения.
	\item Учет теней и эффектов отражения и преломления.
\end{itemize}

\textbf{Недостатки алгоритма обратной трассировки лучей:}
\begin{itemize}
	\item Увеличенное время выполнения из-за рекурсивных вычислений.
\end{itemize}

\subsection*{Вывод}
В качестве алгоритма удаления невидимых линий и поверхностей был выбран алгоритм обратной трассировки лучей, так как с его помощью возможно реализовать эффект отражения, необходимый для решения поставленной задачи. А так же данный алгоритм не требует дополнительной реализации алгоритмов закраски и построения теней.

\clearpage
\section{Анализ модели освещения}
Модель освещения определяет цвет поверхности обьекта отображаемого на экране. Модель освещения бывает двух видов: локальная и глобальная~\cite{rodgersCG}. В локальной модели освещения учитывается только свет падающий от источников и ориентация поверхности в пространстве. В глобальной модели освещения дополнительно еще учитывается свет, отражённый от других поверхностей и/или пропущенный через них.

\subsection{Локальная модель освещения}
Локальная модель освещения состоит из трех компонент~\cite{Phong1975}:

\begin{enumerate}[label=\arabic*)]
	\item \textbf{Фоновое освещение.} Данная составляющая позволяет учитывать свет постоянной яркости, созданный многочисленными отражениями от различных поверхностей. Такой свет практически всегда присутствует в реальной обстановке. Интенсивность  рассеяного света можно рассчитать по формуле~(\ref{eq:amb})
	\begin{equation}\label{eq:amb}
		I_{a} = k_{a} \cdot i_{a}
	\end{equation}
	\noindent где 
	$I_{a}$ --- интенсивность рассеяного света, 
	$k_{a}$ --- коэффициент фонового освещения, 
	$i_{a}$ --- интенсивность источника рассеяного света. 
	
	\item \textbf{Диффузное отражение.} Идеальное диффузное отражение описывается законом Ламберта, согласно которому падающий свет рассеивается во все стороны с одинаковой интенсивностью. Интенсивность диффузного отражения света можно рассчитать по формуле~(\ref{eq:diff})
	
	\begin{equation}\label{eq:diff}
		I_{d} = k_{d} \cdot I_{l} \cdot \frac{\cos(\overrightarrow{L}, \overrightarrow{N})}{r + k}
	\end{equation}
	\noindent где 
	$I_{d}$ --- интенсивность диффузного отражения света, 
	$k_{d}$ --- коэффициент диффузного отражения, 
	$I_{l}$ --- интенсивность точечного источника света,
	$\overrightarrow{L}$ --- вектор направленный на источник света, 
	$\overrightarrow{N}$ --- вектор нормали к поверхности,
	$r$ --- расстояние от центра проекции до поверхности
	$k$ --- произвольная постоянная.
	
	\item \textbf{Зеркальное отражение} Направленное отражение благодары которому на блестящих обьектах образовываются блики. Наблюдатель видит зеркально отраженный свет только в том случае, когда угол отражения от идеальной отражающей поверхности равен углу падения. Интенсивность зеркального отражения света можно рассчитать по формуле~(\ref{eq:specular})
	
	\begin{equation}\label{eq:specular}
		I_{s} = k_{s} \cdot I_{l} \cdot \frac{(\overrightarrow{R}, \overrightarrow{S})^n}{r + k},
	\end{equation}
	
	\noindent где 
	$I_{s}$ --- интенсивность зеркального отражения света,
	$k_{s}$ --- коэффициент зеркального отражения,
	$I_{l}$ --- интенсивность точечного источника света,
	$\overrightarrow{R}$ --- вектор отраженного луча, 
	$\overrightarrow{S}$ --- вектор направленый на наблюдателя,
	$n$ ---  степень, аппроксимирующая пространственное распределение зеркально отраженного света,
	$r$ --- расстояние от центра проекции до поверхности
	$k$ --- произвольная постоянная.
	
	
\end{enumerate}

\subsection{Глобальная модель освещения}
Глобальная модель освещения дополняет локальную модель и позволяет учитывать положение обьектов сцены относительно друг друга, благодары чему появляется возможность визуализировать эффекты отражения света от других обьектов и пропускания света сквозь прозрачные обьекты.

Глобальная модель освещения складывается из непосредственной освещенности точки источником света, которая рассчитывается по локальной модели освещения, и вторичной освещенности, которая в свою очередь состоит из интенсиовности света отраженного и преломленного луча~\cite{shikin2001}. Интенсивность света в точке по глобальной модели освещения расчитывается формулой~(\ref{eq:global}):

\begin{equation}\label{global}
	I = I_{a} + I_{d} + I_{s} + k_{s} \cdot I_{r} + k_{t} \cdot I_{t},
\end{equation}
\noindent где 
	$I_{a}$ --- интенсивность рассеяного света~(\ref{eq:amb}), 
	$I_{d}$ --- интенсивность диффузного отражения света~(\ref{eq:diff}), 
	$I_{s}$ --- интенсивность зеркального отражения света~(\ref{eq:specular}),
	$k_{s}$ --- коэффициент зеркального отражения,
	$k_{t}$ --- коэффициент пропускания,
	$I_{r}$ --- интенсиовности света отраженного луча,
	$I_{t}$ --- интенсиовности света преломленного луча.
\subsection*{Вывод}
Так как для решения поставленной задачи необходимо реализовать отражающую поверхность шахматной доски, в работе использовалась глобальная модель освещения, которая являлась составной частью алгоритма обратной трассировки лучей.


\clearpage
\section*{Вывод из аналитической части}
В данном разделе была формализацована поставленная задача, были рассмотрены способы представления поверхностей трехмерных моделей и методы создания трёхмерного реалистичного изображения. В результате был выбран метод представления трехмерных поверхностей полигональной сеткой и для визуализации трехмерной сцены был выбран алгоритм обратной трассировки лучей, который включает в себя глобальную модель освещения.

\clearpage
